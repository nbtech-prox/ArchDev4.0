---
- name: Core System Setup & Configuration
  hosts: all
  become: true
  
  pre_tasks:
    - name: Validate Arch Linux
      fail:
        msg: "‚ùå Este playbook √© exclusivo para Arch Linux. Detectado: {{ ansible_facts['distribution'] }}"
      when: ansible_facts['distribution'] != 'Archlinux'
      tags: [always, validation]
    
    - name: Validate BTRFS filesystem for Snapper
      fail:
        msg: "‚ùå Snapper requer filesystem BTRFS. Root est√° usando: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('desconhecido') }}"
      when: 
        - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('') != 'btrfs'
      tags: [always, validation, btrfs]
      ignore_errors: true  # Permite continuar sem Snapper se n√£o for BTRFS
    
    - name: Display validation warning
      debug:
        msg: "‚ö†Ô∏è  Filesystem n√£o √© BTRFS - Snapper ser√° ignorado"
      when: 
        - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('') != 'btrfs'
      tags: [always, validation, btrfs]
    
    - name: Validate sudo access
      command: whoami
      become: true
      changed_when: false
      tags: [always, validation]
    
    - name: Display system info
      debug:
        msg: |
          üîß ArchDev 3.0 - Informa√ß√µes do Sistema:
          ‚Ä¢ Distribui√ß√£o: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          ‚Ä¢ Kernel: {{ ansible_facts['kernel'] }}
          ‚Ä¢ Filesystem Root: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('desconhecido') }}
          ‚Ä¢ Usu√°rio: {{ ansible_env.SUDO_USER | default(ansible_user_id) }}
          ‚Ä¢ Arquitetura: {{ ansible_facts['architecture'] }}
      tags: [always, validation]
  
  roles:
    - common
    - system
    - desktop
    - dev
    - dotfiles
