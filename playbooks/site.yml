---
- name: Core System Setup & Configuration
  hosts: all
  become: true
  
  pre_tasks:
    # --- SUDO TIMEOUT (PRIMEIRO DE TUDO - evita prompts de senha) ---
    - name: Configure sudo timeout (90 minutes)
      lineinfile:
        path: /etc/sudoers.d/timeout
        line: 'Defaults timestamp_timeout=90'
        create: yes
        owner: root
        group: root
        mode: '0440'
        validate: 'visudo -cf %s'
      tags: [always, sudo]
    
    - name: Validate Arch Linux
      fail:
        msg: "‚ùå Este playbook √© exclusivo para Arch Linux. Detectado: {{ ansible_facts['distribution'] }}"
      when: ansible_facts['distribution'] != 'Archlinux'
      tags: [always, validation]
    
    - name: Validate BTRFS filesystem for Snapper
      fail:
        msg: "‚ùå Snapper requer filesystem BTRFS. Root est√° usando: {{ ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('desconhecido') }}"
      when: 
        - ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('') != 'btrfs'
      tags: [always, validation, btrfs]
      ignore_errors: true  # Permite continuar sem Snapper se n√£o for BTRFS
    
    - name: Display validation warning
      debug:
        msg: "‚ö†Ô∏è  Filesystem n√£o √© BTRFS - Snapper ser√° ignorado"
      when: 
        - ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('') != 'btrfs'
      tags: [always, validation, btrfs]
    
    - name: Validate sudo access
      command: whoami
      become: true
      changed_when: false
      tags: [always, validation]
    
    - name: Display system info
      debug:
        msg: |
          üîß ArchDev 3.0 - Informa√ß√µes do Sistema:
          ‚Ä¢ Distribui√ß√£o: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          ‚Ä¢ Kernel: {{ ansible_facts['kernel'] }}
          ‚Ä¢ Filesystem Root: {{ ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('desconhecido') }}
          ‚Ä¢ Usu√°rio: {{ ansible_facts['env']['SUDO_USER'] | default(ansible_facts['user_id']) }}
          ‚Ä¢ Arquitetura: {{ ansible_facts['architecture'] }}
      tags: [always, validation]
  
  roles:
    - common
    - system
    - desktop
    - dev
    - dotfiles
