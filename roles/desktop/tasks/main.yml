---
# --- Install Desktop Packages ---
- name: Install all desktop package groups
  pacman:
   name: "{{ item }}"
   state: present
  loop:
   - "{{ packages_hyprland | default([]) }}"
   - "{{ packages_theme | default([]) }}"
   - "{{ packages_terminal | default([]) }}"
  become: yes
  tags: [desktop, packages]

# --- SDDM Theme ---
- name: Ensure SDDM config directory exists
  file:
    path: /etc/sddm.conf.d
    state: directory
    mode: '0755'
  become: yes
  tags: [desktop, sddm]

- name: Set SDDM Theme to Catppuccin Mocha
  copy:
    dest: /etc/sddm.conf.d/theme.conf
    content: |
      [Theme]
      Current=catppuccin-mocha-mauve
  become: yes
  notify: Restart SDDM
  tags: [desktop, sddm]

# NOTA: Firefox profile e user.js configurados em assets.yml

# --- Spicetify (Seguro) ---
- name: Check if Spicetify is installed
  command: which spicetify
  register: spicetify_check
  ignore_errors: true
  changed_when: false
  tags: [desktop, spicetify]

- name: Check if Spotify is installed
  command: which spotify
  register: spotify_check
  ignore_errors: true
  changed_when: false
  tags: [desktop, spicetify]

# SOLUÇÃO SEGURA: Mudar grupo para o usuário e dar permissão ao grupo
- name: Set Spotify Permissions for Spicetify (Secure)
  file:
    path: /opt/spotify
    owner: root
    group: "{{ target_user }}"  # Muda o grupo para o teu usuário
    mode: '0775'                # rwxrwxr-x (dono e grupo podem escrever)
    recurse: yes
  when: 
    - spicetify_check.rc == 0
    - spotify_check.rc == 0
    - ansible_facts['os_family'] == 'Archlinux'
  ignore_errors: true
  tags: [desktop, spicetify]

# Alternativa ainda melhor: Usar ACL (Access Control List)
# Isto dá permissão específica ao teu usuário sem mudar o grupo
- name: Set Spotify Permissions using ACL (Mais Seguro)
  ansible.posix.acl:
    path: /opt/spotify
    entity: "{{ target_user }}"
    etype: user
    permissions: rwx
    recursive: yes
    state: present
  when: 
    - spicetify_check.rc == 0
    - spotify_check.rc == 0
  ignore_errors: true
  tags: [desktop, spicetify]

- name: Apply Spicetify Theme (Catppuccin Mocha)
  shell: |
    spicetify config current_theme catppuccin
    spicetify config color_scheme mocha
    spicetify config inject_css 1 replace_colors 1 overwrite_assets 1
    spicetify backup apply
  become: no
  when: 
    - spicetify_check.rc == 0
    - spotify_check.rc == 0
    - spotify_prefs.stat.exists
  tags: [desktop, spicetify]
  register: spicetify_theme
  changed_when: "'already backed up' not in spicetify_theme.stderr"

- include_tasks: assets.yml
  tags: [desktop, assets]

- name: Enable display manager (SDDM)
  systemd:
   name: sddm
   enabled: yes
   state: started
