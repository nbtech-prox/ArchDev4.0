---
# --- Install Desktop Packages ---
- name: Install all desktop package groups
  pacman:
   name: "{{ item }}"
   state: present
  loop:
   - "{{ packages_hyprland | default([]) }}"
   - "{{ packages_theme | default([]) }}"
   - "{{ packages_terminal | default([]) }}"
  become: yes
  tags: [desktop, packages]

# --- SDDM Theme ---
- name: Ensure SDDM config directory exists
  file:
    path: /etc/sddm.conf.d
    state: directory
    mode: '0755'
  become: yes
  tags: [desktop, sddm]

- name: Set SDDM Theme to Catppuccin Mocha
  copy:
    dest: /etc/sddm.conf.d/theme.conf
    content: |
      [Theme]
      Current=catppuccin-mocha-mauve
  become: yes
  notify: Restart SDDM
  tags: [desktop, sddm]

# NOTA: Firefox profile e user.js configurados em assets.yml

# --- Spicetify (Seguro) ---
- name: Check if Spicetify is installed in Distrobox
  shell: distrobox-enter arch-dev-box -- command -v spicetify
  register: spicetify_check
  ignore_errors: true
  changed_when: false
  become: no
  tags: [desktop, spicetify]

- name: Check if Spotify is installed in Distrobox
  shell: distrobox-enter arch-dev-box -- command -v spotify
  register: spotify_check
  ignore_errors: true
  changed_when: false
  become: no
  tags: [desktop, spicetify]

- name: Set Spotify Permissions using ACL inside Distrobox
  shell: |
    distrobox-enter arch-dev-box -- sudo setfacl -R -m u:{{ target_user }}:rwx /opt/spotify
  when: 
    - spicetify_check.rc == 0
    - spotify_check.rc == 0
  ignore_errors: true
  become: no
  tags: [desktop, spicetify]

- name: Check if Spotify preferences file exists
  stat:
    path: "{{ target_home }}/.config/spotify/prefs"
  register: spotify_prefs
  when:
    - spicetify_check.rc == 0
    - spotify_check.rc == 0
  tags: [desktop, spicetify]

- name: Apply Spicetify Theme (Catppuccin Mocha) inside Distrobox
  shell: |
    distrobox-enter arch-dev-box -- bash -c '
    spicetify config current_theme catppuccin
    spicetify config color_scheme mocha
    spicetify config inject_css 1 replace_colors 1 overwrite_assets 1
    spicetify backup apply
    '
  become: no
  when: 
    - spicetify_check.rc == 0
    - spotify_check.rc == 0
    - spotify_prefs.stat.exists | default(false)
  tags: [desktop, spicetify]
  register: spicetify_theme
  changed_when: "'already backed up' not in spicetify_theme.stderr"

- include_tasks: assets.yml
  tags: [desktop, assets]

- name: Enable display manager (SDDM)
  systemd:
   name: sddm
   enabled: yes
   state: started
