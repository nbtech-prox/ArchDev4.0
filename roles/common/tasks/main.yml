---
- name: Configure UFW Defaults
  ufw:
    state: enabled
    policy: deny
    direction: incoming
  become: yes
  tags: [system, firewall]

- name: Allow Outgoing UFW
  ufw:
    state: enabled
    policy: allow
    direction: outgoing
  become: yes
  tags: [system, firewall]

- name: Allow SSH
  ufw:
    rule: allow
    port: '22'
    proto: tcp
  become: yes
  tags: [system, firewall]

- name: Allow Dev Ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - '8000' # Laravel
    - '8080' # Node
    - '5000' # Flask
    - '8550' # Flet
  become: yes
  tags: [system, firewall]

- name: Update system packages (Arch Linux)
  pacman:
    update_cache: yes
    upgrade: yes
  tags: [system, update]

- name: Install base system utilities
  pacman:
    name: "{{ packages_system + packages_admin + ['rsync'] }}"
    state: present
  tags: [system, base]

- name: Enable essential services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - ufw
    - sshd
    - NetworkManager
    - bluetooth
  ignore_errors: true
  tags: [system, services]

# Include AUR tasks
- include_tasks: aur.yml
  tags: [aur]

# --- Security Hardening ---
- name: Configure Fail2ban for SSH protection
  copy:
    src: fail2ban-ssh.conf
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify: Restart Fail2ban
  tags: [security, fail2ban]

- name: Enable and start Fail2ban
  systemd:
    name: fail2ban
    enabled: yes
    state: started
  tags: [security, fail2ban]

- name: Configure sudo timeout (30 minutes)
  lineinfile:
    path: /etc/sudoers.d/timeout
    line: 'Defaults timestamp_timeout=30'
    create: yes
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: [security, sudo]

- name: Ensure security directory exists
  file:
   path: /etc/system-hardening
   state: directory
   mode: '0755'
  become: true

- name: Create security audit notice
  copy:
    content: |
      ================================================
      üõ°Ô∏è  SEGURAN√áA DO SISTEMA - RESUMO
      ================================================
      
      Prote√ß√µes Ativas:
      
      1. Firewall (UFW)
         - Bloqueia conex√µes de entrada
         - Permite apenas SSH (porta 22)
         - Portas dev abertas: 8000, 8080, 5000, 8550
      
      2. Fail2ban
         - Protege SSH contra brute force
         - Bloqueia IP ap√≥s 3 tentativas falhadas
         - BAN dura 1 hora
      
      3. Btrfs + Snapper
         - Snapshots autom√°ticos
         - Rollback no boot (Limine)
         - 3 snapshots mantidos
      
      4. Password Manager (pass)
         - Passwords cifradas com GPG
         - Integrado com rofi (Super+P)
      
      Comandos √öteis:
         sudo ufw status              # Ver firewall
         sudo fail2ban-client status  # Ver fail2ban
         sudo lynis audit system      # Auditoria completa
         archdev-backup-keys          # Backup chaves (em ~/.config/helpers/)
      
      ================================================
    dest: /etc/system-hardening/security-notice.txt
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: true
  tags: [security]
