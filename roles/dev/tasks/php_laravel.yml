---
# --- ASDF Setup for PHP Version Management ---
# Permite usar 'bubble l' para criar ambientes PHP isolados com versões específicas
- name: Install ASDF PHP plugin
  shell: |
    . /opt/asdf-vm/asdf.sh
    asdf plugin add php https://github.com/asdf-community/asdf-php.git || true
  args:
    executable: /bin/bash
  ignore_errors: yes
  tags: [dev, php, asdf]

- name: Ensure ASDF shims are in PATH for subsequent tasks
  lineinfile:
    path: "{{ ansible_user_dir }}/.zshenv"
    line: 'export PATH="${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"'
    create: yes
    owner: "{{ default_user }}"
    group: "{{ default_user }}"
    mode: '0644'
  ignore_errors: yes
  tags: [dev, php, asdf]

- name: Set PHP timezone
  lineinfile:
    path: /etc/php/php.ini
    regexp: ';date.timezone ='
    line: 'date.timezone = UTC'
  tags: [dev, php]

# --- Enable Extensions ---
- name: Enable PHP extensions
  lineinfile:
    path: /etc/php/php.ini
    regexp: ';extension={{ item }}'
    line: 'extension={{ item }}'
  loop:
    - bcmath
    - intl
    - pdo_mysql
    - sqlite3
    - curl
    - iconv
    - zip
    - mysqli
    - openssl
    - gd
    - bz2
    - exif
    - fileinfo
    - ftp
    - gettext
    - mbstring
  notify: Restart PHP-FPM
  tags: [dev, php, extensions]

# --- PHP Development Configuration ---
- name: Configure PHP for Development (Laravel Optimized)
  lineinfile:
    path: /etc/php/php.ini
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  loop:
    # Memory
    - { regexp: '^memory_limit\s*=.*', line: 'memory_limit = 512M' }
    # File Uploads
    - { regexp: '^upload_max_filesize\s*=.*', line: 'upload_max_filesize = 128M' }
    - { regexp: '^post_max_size\s*=.*', line: 'post_max_size = 128M' }
    - { regexp: '^max_file_uploads\s*=.*', line: 'max_file_uploads = 20' }
    # Execution
    - { regexp: '^max_execution_time\s*=.*', line: 'max_execution_time = 300' }
    - { regexp: '^max_input_time\s*=.*', line: 'max_input_time = 300' }
    - { regexp: '^max_input_vars\s*=.*', line: 'max_input_vars = 5000' }
    # Error Reporting (Development)
    - { regexp: '^error_reporting\s*=.*', line: 'error_reporting = E_ALL' }
    - { regexp: '^display_errors\s*=.*', line: 'display_errors = On' }
    - { regexp: '^display_startup_errors\s*=.*', line: 'display_startup_errors = On' }
    - { regexp: '^log_errors\s*=.*', line: 'log_errors = On' }
    # OPcache (Performance)
    - { regexp: '^;opcache.enable\s*=.*', line: 'opcache.enable = 1' }
    - { regexp: '^;opcache.memory_consumption\s*=.*', line: 'opcache.memory_consumption = 256' }
    - { regexp: '^;opcache.max_accelerated_files\s*=.*', line: 'opcache.max_accelerated_files = 20000' }
    - { regexp: '^;opcache.revalidate_freq\s*=.*', line: 'opcache.revalidate_freq = 0' }
    - { regexp: '^;opcache.validate_timestamps\s*=.*', line: 'opcache.validate_timestamps = 1' }
    # Realpath Cache
    - { regexp: '^;realpath_cache_size\s*=.*', line: 'realpath_cache_size = 4096K' }
    - { regexp: '^;realpath_cache_ttl\s*=.*', line: 'realpath_cache_ttl = 600' }
  notify: Restart PHP-FPM
  tags: [dev, php, config]

# --- Composer ---
- name: Install Composer globally
  get_url:
    url: https://getcomposer.org/composer-stable.phar
    dest: /usr/local/bin/composer
    mode: '0755'
  tags: [dev, php, composer]

# --- MariaDB ---
- name: Initialize MariaDB data directory
  command: mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
  args:
    creates: /var/lib/mysql/mysql
  tags: [dev, mariadb]

- name: Start and enable MariaDB service
  systemd:
    name: mariadb
    enabled: yes
    state: started
  tags: [dev, mariadb]

- name: Apply MariaDB Custom Optimization
  copy:
    src: mariadb_custom.cnf
    dest: /etc/my.cnf.d/z-custom-archdev.cnf
    owner: root
    group: root
    mode: '0644'
  notify: Restart MariaDB
  tags: [dev, mariadb]

# --- Apache & phpMyAdmin ---
- name: Install Apache phpMyAdmin Config
  copy:
    src: apache_phpmyadmin.conf
    dest: /etc/httpd/conf/extra/phpmyadmin.conf
    owner: root
    group: root
    mode: '0644'
  tags: [dev, apache, phpmyadmin]

- name: Install phpMyAdmin Config
  copy:
    src: phpmyadmin_config.inc.php
    dest: /etc/webapps/phpmyadmin/config.inc.php
    owner: root
    group: http
    mode: '0640'
  tags: [dev, phpmyadmin]

- name: Generate Random Blowfish Secret for phpMyAdmin
  shell: openssl rand -base64 32 | tr -d /=+ | cut -c -32
  register: blowfish_secret
  changed_when: false
  tags: [dev, phpmyadmin]

- name: Set Blowfish Secret
  replace:
    path: /etc/webapps/phpmyadmin/config.inc.php
    regexp: 'ARCHDEV_REPLACE_ME_WITH_RANDOM_STRING_32CH'
    replace: "{{ blowfish_secret.stdout }}"
  tags: [dev, phpmyadmin]

- name: Include phpMyAdmin in Apache Config
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    line: "Include conf/extra/phpmyadmin.conf"
    state: present
  notify: Restart Apache
  tags: [dev, apache, phpmyadmin]

- name: Enable MPM Prefork (Required for mod_php)
  replace:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^LoadModule mpm_event_module'
    replace: '#LoadModule mpm_event_module'
  tags: [dev, apache]

- name: Ensure MPM Prefork is loaded
  replace:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^#LoadModule mpm_prefork_module'
    replace: 'LoadModule mpm_prefork_module'
  notify: Restart Apache
  tags: [dev, apache]

- name: Start and enable Apache service
  systemd:
    name: httpd
    enabled: yes
    state: started
  tags: [dev, apache]
