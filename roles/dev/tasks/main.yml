---
# --------------------------------------------------------
# Install Development Packages
# --------------------------------------------------------

- name: Install Developer Tools
  pacman:
    name: "{{ packages_dev_tools + packages_terminal }}"
    state: present
  become: yes
  tags: [dev, tools]

- name: Install Web Dev Stack (PHP/Laravel)
  pacman:
    name: "{{ packages_dev_web }}"
    state: present
  become: yes
  tags: [dev, web]

- name: Install Python Stack
  pacman:
    name: "{{ packages_dev_python }}"
    state: present
  become: yes
  tags: [dev, python]

# --------------------------------------------------------
# Docker Setup
# --------------------------------------------------------

- name: Add user to Docker group
  user:
    name: "{{ target_user }}"
    groups: docker
    append: yes
  become: yes
  tags: [dev, docker]

- name: Enable Docker Service
  systemd:
    name: docker
    enabled: yes
    state: started
  become: yes
  tags: [dev, docker]

# --------------------------------------------------------
# Include Subtasks
# --------------------------------------------------------

- include_tasks: php_laravel.yml
  tags: [dev, web]

- include_tasks: python.yml
  tags: [dev, python]

- include_tasks: docker_tuning.yml
  tags: [dev, docker]

- include_tasks: git_autosync.yml
  tags: [dev, git-autosync]

- include_tasks: pass_helper.yml
  tags: [dev, pass]

# --------------------------------------------------------
# Helpers Directory Structure
# --------------------------------------------------------

- name: Ensure helpers directory exists
  file:
    path: "{{ target_home }}/.config/helpers"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  tags: [dev, helpers]

- name: Install helpers README
  copy:
    src: helpers-readme.txt
    dest: "{{ target_home }}/.config/helpers/README.txt"
    mode: '0644'
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  tags: [dev, helpers]

# --------------------------------------------------------
# Bitwarden Setup (substitui pass)
# --------------------------------------------------------

- name: Install Bitwarden setup helper
  copy:
    src: bitwarden-setup.sh
    dest: "{{ target_home }}/.config/helpers/bitwarden-setup.sh"
    mode: '0755'
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  tags: [dev, bitwarden, helpers]

- name: Create symlink for bitwarden helper
  file:
    src: "{{ target_home }}/.config/helpers/bitwarden-setup.sh"
    dest: /usr/local/bin/archdev-bitwarden-setup
    state: link
    force: yes
  become: yes
  tags: [dev, bitwarden, helpers]

- name: Create Bitwarden notice
  copy:
    content: |
      ================================================
      üîê BITWARDEN PASSWORD MANAGER
      ================================================
      
      O rbw e rofi-rbw est√£o instalados.
      
      Para configurar:
         archdev-bitwarden-setup
         
      Ou diretamente:
         ~/.config/helpers/bitwarden-setup.sh
      
      Comandos √∫teis:
         rbw login          # Fazer login
         rbw sync           # Sincronizar vault
         rofi-rbw           # Interface gr√°fica (Super+P)
         
      Atalho: Super+P ‚Üí Abrir seletor de passwords
      
      ================================================
    dest: "{{ target_home }}/.config/helpers/bitwarden-notice.txt"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  tags: [dev, bitwarden, helpers]

# --------------------------------------------------------
# Security & Helper Scripts
# --------------------------------------------------------

- name: Install backup keys helper script
  copy:
    src: backup-keys.sh
    dest: "{{ target_home }}/.config/helpers/backup-keys.sh"
    mode: '0755'
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  tags: [dev, security, helpers]

- name: Create symlink for backup-keys helper
  file:
    src: "{{ target_home }}/.config/helpers/backup-keys.sh"
    dest: /usr/local/bin/archdev-backup-keys
    state: link
    force: yes
  become: yes
  tags: [dev, security, helpers]

- name: Create backup keys notice
  copy:
    content: |
      ================================================
      üîê BACKUP DE CHAVES DE SEGURAN√áA
      ================================================
      
      Execute regularmente:
         archdev-backup-keys
         
      Ou diretamente:
         ~/.config/helpers/backup-keys.sh
      
      ================================================
    dest: "{{ target_home }}/.config/helpers/keys-backup-notice.txt"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  tags: [dev, security, helpers]

# --------------------------------------------------------
# MariaDB Setup
# --------------------------------------------------------

- name: Enable MariaDB Service
  systemd:
    name: mariadb
    enabled: yes
    state: started
  become: yes
  tags: [dev, mariadb]

- name: Install MariaDB setup helper
  copy:
    src: mariadb-setup.sh
    dest: "{{ target_home }}/.config/helpers/mariadb-setup.sh"
    mode: '0755'
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  tags: [dev, mariadb, helpers]

- name: Create symlink for mariadb helper
  file:
    src: "{{ target_home }}/.config/helpers/mariadb-setup.sh"
    dest: /usr/local/bin/archdev-mariadb-setup
    state: link
    force: yes
  become: yes
  tags: [dev, mariadb, helpers]

- name: Create MariaDB notice
  copy:
    content: |
      ================================================
      üóÑÔ∏è  MARIADB SETUP
      ================================================
      
      Execute:
         sudo archdev-mariadb-setup
         
      Ou diretamente:
         sudo ~/.config/helpers/mariadb-setup.sh
      
      ================================================
    dest: "{{ target_home }}/.config/helpers/mariadb-notice.txt"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  tags: [dev, mariadb, helpers]
