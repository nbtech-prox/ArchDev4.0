---
# --- Password Manager (pass) Helper ---
# Configura√ß√£o inicial do pass + rofi-pass

- name: Ensure password store directory exists
  file:
    path: "{{ target_home }}/.password-store"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0700'
  tags: [dev, pass]

- name: Ensure gnupg directory exists
  file:
    path: "{{ target_home }}/.gnupg"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0700'
  tags: [dev, pass]

- name: Copy pass setup helper script
  copy:
    content: |
      #!/bin/bash
      # ArchDev - Password Store Setup Helper
      
      set -e
      
      GREEN='\033[0;32m'
      BLUE='\033[0;34m'
      YELLOW='\033[1;33m'
      NC='\033[0m'
      
      echo -e "${BLUE}üîê ArchDev Password Store Setup${NC}"
      echo "=========================================="
      echo ""
      
      # Verifica se j√° existe chave GPG
      if gpg --list-secret-keys --keyid-format LONG | grep -q "sec"; then
          echo -e "${GREEN}‚úì Chave GPG existente encontrada.${NC}"
          gpg --list-secret-keys --keyid-format LONG
      else
          echo -e "${YELLOW}‚ö† Nenhuma chave GPG encontrada.${NC}"
          echo ""
          echo "Vamos criar uma nova chave GPG para o password store."
          echo ""
          echo -e "${BLUE}Instru√ß√µes:${NC}"
          echo "  1. Tipo de chave: RSA and RSA (default)"
          echo "  2. Tamanho: 4096"
          echo "  3. Validade: 0 (n√£o expira)"
          echo "  4. Nome Real: O seu nome"
          echo "  5. Email: O seu email"
          echo "  6. Coment√°rio: (deixe em branco)"
          echo "  7. Confirme com 'O' (Ok)"
          echo ""
          echo -e "${YELLOW}Pressione ENTER para criar a chave...${NC}"
          read
          
          gpg --full-generate-key
      fi
      
      # Obt√©m o ID da chave
      KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
      
      if [ -z "$KEY_ID" ]; then
          echo -e "${RED}‚úó Erro: N√£o foi poss√≠vel obter o ID da chave GPG.${NC}"
          exit 1
      fi
      
      echo ""
      echo -e "${GREEN}‚úì Chave GPG: ${KEY_ID}${NC}"
      
      # Inicializa o password store
      if [ ! -d "$HOME/.password-store/.git" ]; then
          echo ""
          echo -e "${BLUE}üìÅ Inicializando password store...${NC}"
          pass init "$KEY_ID"
          echo -e "${GREEN}‚úì Password store inicializado!${NC}"
      else
          echo -e "${GREEN}‚úì Password store j√° inicializado.${NC}"
      fi
      
      echo ""
      echo "=========================================="
      echo -e "${GREEN}‚úì Setup conclu√≠do!${NC}"
      echo "=========================================="
      echo ""
      echo "Comandos √∫teis:"
      echo "  pass insert github.com/username     # Adicionar password"
      echo "  pass show github.com/username       # Ver password"
      echo "  pass generate github.com/new 20     # Gerar password nova"
      echo "  rofi-pass                           # Interface gr√°fica (Super+P)"
      echo ""
      echo -e "${YELLOW}‚ö† Importante: Fa√ßa backup da sua chave GPG!${NC}"
      echo "  gpg --export-secret-keys --armor $KEY_ID > gpc-backup.asc"
      echo ""
    dest: /usr/local/bin/archdev-pass-setup
    mode: '0755'
    owner: root
    group: root
  tags: [dev, pass]

- name: Create pass setup notice
  copy:
    content: |
      ================================================
      üîê PASSWORD MANAGER (pass) - SETUP P√ìS-INSTALA√á√ÉO
      ================================================
      
      O pass e rofi-pass est√£o instalados, mas precisam
      de configura√ß√£o inicial.
      
      Execute:
         archdev-pass-setup
      
      Este script vai:
         1. Criar chave GPG (se n√£o existir)
         2. Inicializar o password store
         3. Configurar tudo automaticamente
      
      Depois use:
         Super+P  ‚Üí Abrir rofi-pass (interface gr√°fica)
         pass     ‚Üí Comando CLI
      
      ================================================
    dest: "{{ target_home }}/.config/pass-notice.txt"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  tags: [dev, pass]

- name: Display pass notice
  debug:
    msg: |
      ================================================
      üîê PASSWORD MANAGER (pass) - SETUP P√ìS-INSTALA√á√ÉO
      ================================================
      
      Execute: archdev-pass-setup
      Depois: Super+P para abrir rofi-pass
      ================================================
  tags: [dev, pass]
