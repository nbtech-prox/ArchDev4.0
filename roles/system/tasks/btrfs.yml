---
# --------------------------------------------------------
# Detect filesystem type
# --------------------------------------------------------

- name: Detect root filesystem type
  set_fact:
    root_fstype: "{{ ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first | default('unknown') }}"
  tags: [system, btrfs, always]

- name: Display filesystem info
  debug:
    msg: "üìÅ Filesystem root detectado: {{ root_fstype }}"
  tags: [system, btrfs, always]

# --------------------------------------------------------
# Ensure optimal BTRFS mount options
# --------------------------------------------------------

- name: Ensure BTRFS mount options use noatime
  replace:
    path: /etc/fstab
    regexp: 'relatime'
    replace: 'noatime'
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

# --------------------------------------------------------
# BTRFS + Snapper Configuration (ArchDev3.0 Production)
# --------------------------------------------------------

- name: Install Snapper and snap-pac
  pacman:
    name:
      - snapper
      - snap-pac
    state: present
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs, snapper]

# --------------------------------------------------------
# Create Snapper Config (Root)
# --------------------------------------------------------

- name: Configure Snapper for Root
  command: snapper -c root create-config /
  args:
    creates: /etc/snapper/configs/root
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs, snapper]

# --------------------------------------------------------
# Snapper Retention Policy (ONLY 3 SNAPSHOTS TOTAL)
# --------------------------------------------------------

- name: Adjust Snapper Retention Policy (Limit 3 total)
  lineinfile:
    path: /etc/snapper/configs/root
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}=\"{{ item.value }}\""
  loop:
    - { key: 'NUMBER_LIMIT', value: '3' }
    - { key: 'NUMBER_LIMIT_IMPORTANT', value: '0' }
    - { key: 'TIMELINE_CREATE', value: 'no' }
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs, snapper]

# --------------------------------------------------------
# Enable Cleanup Timer (NO timeline timer)
# --------------------------------------------------------

- name: Enable Snapper Cleanup Timer
  systemd:
    name: snapper-cleanup.timer
    enabled: yes
    state: started
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs, snapper]

# --------------------------------------------------------
# Ensure correct permissions
# --------------------------------------------------------

- name: Ensure correct permissions for .snapshots
  file:
    path: /.snapshots
    mode: '0750'
    state: directory
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs, snapper]

# --------------------------------------------------------
# Cleanup immediately (important for first run)
# --------------------------------------------------------

- name: Cleanup old Snapper snapshots immediately
  command: snapper -c root cleanup number
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs, snapper]

# --------------------------------------------------------
# Generate Limine Snapshot Entries (Modern Compatible)
# --------------------------------------------------------

- name: Check if Limine config exists
  stat:
    path: /boot/limine/limine.conf
  register: limine_conf
  tags: [system, btrfs, boot]

- name: Generate Limine snapshot entries
  command: /usr/local/bin/generate-limine-snapshots.sh
  become: yes
  when: 
    - root_fstype == 'btrfs'
    - limine_conf.stat.exists
  tags: [system, btrfs, boot]

# --------------------------------------------------------
# BTRFS maintenance: scrub + light balance (systemd timers)
# --------------------------------------------------------

- name: Install BTRFS scrub systemd unit
  copy:
    src: btrfs-scrub@.service
    dest: /etc/systemd/system/btrfs-scrub@.service
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

- name: Install BTRFS scrub systemd timer
  copy:
    src: btrfs-scrub@.timer
    dest: /etc/systemd/system/btrfs-scrub@.timer
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

- name: Install BTRFS balance systemd unit
  copy:
    src: btrfs-balance@.service
    dest: /etc/systemd/system/btrfs-balance@.service
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

- name: Install BTRFS balance systemd timer
  copy:
    src: btrfs-balance@.timer
    dest: /etc/systemd/system/btrfs-balance@.timer
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes
  tags: [system, btrfs]

- name: Enable BTRFS scrub timer for root mount
  systemd:
    name: "btrfs-scrub@-.timer"
    enabled: yes
    state: started
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

- name: Enable BTRFS balance timer for root mount
  systemd:
    name: "btrfs-balance@-.timer"
    enabled: yes
    state: started
  become: yes
  when: root_fstype == 'btrfs'
  tags: [system, btrfs]

# --------------------------------------------------------
# System performance tuning
# --------------------------------------------------------

- name: Deploy system performance sysctl config
  copy:
    src: 99-performance.conf
    dest: /etc/sysctl.d/99-performance.conf
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags: [system, performance]

- name: Apply sysctl settings
  command: sysctl --system
  become: yes
  tags: [system, performance]

